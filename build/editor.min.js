/*! editor 2014-11-16 */
Array.prototype.find||(Array.prototype.find=function(a){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof a)throw new TypeError("predicate must be a function");for(var b,c=Object(this),d=c.length>>>0,e=arguments[1],f=0;d>f;f++)if(b=c[f],a.call(e,b,f,c))return b;return void 0}),function(a,b,c,d){"use strict";function e(){}function f(){var b;b=a("[data-serene-editor]"),b.length>1?(console.log("Multiple editors not supported. Picking up first."),b=b.first()):0===b.length&&(b=a("<div>").attr("data-serene-editor",""),a("body").append(b)),I.root=b,b=I.root.find("[data-serene-menu-container]"),0===b.length&&(b=a("<div>").attr("data-serene-menu-container","").addClass("menu-container"),I.root.append(b)),I.menu=b,b=I.root.find("article[data-serene-edit]"),0===b.length&&(b=a("<article>").attr("data-serene-edit","").append(a("<h2>").attr("data-placeholder","Title here").addClass("title")).append(a("<p>")),I.root.append(b)),I.editor=b,b=I.menu.find("[data-serene-options]"),0===b.length&&(b=a("<div>").attr("data-serene-options","").append(a("<div>").addClass("toggle").append(a("a").addClass("button icon").attr({href:"#","data-id":"toggle"}).html("&times;"))).append(a("<div>").addClass("menu options-menu").html("<div><div></div></div>")),I.menu.append(b)),I.options=b,I.editor.attr({contenteditable:!0}),I.menu.find("> *").hide(),I.lastFocused=d}function g(){a(c).on({compositionend:r,compositionstart:q,keyup:l,keydown:m,mousedown:n,mouseup:o,scroll:p}),P={top:a(b).scrollTop(),left:a(b).scrollLeft(),timestamp:(new Date).getTime()},I.menu.on("click",'a[href="#"]',w),I.editor.on("mouseenter","> *",v),a(b).on({resize:s})}function h(){J.localStorage=b.hasOwnProperty("localStorage")&&null!==b.localStorage}function i(b,c){var d,e;return-1===c&&(c=K.length,K.push(b)),I.menu.append(b.view),b.R={},b.view.find('a[href="#"]').each(function(){var d=a(this).attr("data-button-id").replace(/-([a-z0-9])/gi,function(a){return a[1].toUpperCase()});b.R[d]=H+=1,a(this).attr("data-extension-binder-id",c),a(this).attr("data-button-binder-id",H)}),e=[],b.subscribe.forEach(function(a){d=/^@.*$/gi,d.test(a)?(N[a]||(N[a]=[]),N[a].push(b.onEvent)):e.push(a)}),b.subscribe=e,c}function j(){var a;for(T=!0,a=0;a<K.length;++a)i(K[a],a);O=!0,T=!1}function k(){}function l(b){var c,e,f,g,h,i;i=y(),e=i[0],f=i[1],g=i[2],L=i[3],h=i[4],c=a(b.target),(e||I.lastFocused&&I.lastFocused!==c)&&u("keyup",I.lastFocused),F=h,K[0].onFocusIn(),f?(c=a(h.focusNode),t("keyup",h.focusNode.nodeName.toLowerCase(),c,b,g),I.lastFocused=c):I.lastFocused&&(u("keyup",c),I.lastFocused=d)}function m(b){var c,d,e,f=[];f.push(b.which),b.shiftKey&&f.push(16),b.ctrlKey&&f.push(17),b.altKey&&f.push(18),b.metaKey&&f.push(91),d=B(f),N.hasOwnProperty(d)&&(e=y()[4],c=a(e.focusNode),N[d].some(function(a){return a(d,c,b,e)}))}function n(){}function o(b){var c,e,f,g,h,i,j;1===b.which&&(j=y(),e=j[0],f=j[1],g=j[2],h=j[3],i=j[4],c=a(b.target),(e||I.lastFocused&&I.lastFocused!==c)&&u("mouseup",I.lastFocused),F=i,L=h,f?(c=a(i.focusNode),t("mouseup",i.focusNode.nodeName.toLowerCase(),c,b,g),I.lastFocused=c):a.contains(I.editor[0],b.target)?(t("mouseup",b.target.nodeName.toLowerCase(),c,b),I.lastFocused=c):I.lastFocused=d)}function p(){var c={top:a(b).scrollTop(),left:a(b).scrollLeft(),timestamp:(new Date).getTime()},d={x:c.left-P.left,y:c.top-P.top,dt:c.timestamp-P.timestamp};return d.dt>3*U?(z(d),P=c,void(Q=0)):(0!==Q&&b.clearTimeout(Q),void(Q=b.setTimeout(function(){Q=0,z(d)},U)))}function q(){R=!0}function r(){R=!1}function s(){z(d,!0)}function t(a,b,c,d,e){M={},M.type=a,M.event=d,M.where=e?e:{top:c.position().top,right:c.position().left+c.outerWidth(!0),bottom:c.position().top+c.outerHeight(!0),left:c.position().left,width:c.width(),height:c.height(),marginTop:(c.outerHeight(!0)-c.height())/2,marginLeft:(c.outerWidth(!0)-c.width())/2},M.view=c,M.nodeName=b,K.forEach(function(e){e.subscribe.find(function(a){return a===b})&&e.onFocusIn(a,b,c,d)}),K.forEach(function(e){e.subscribe.find(function(a){return"*"===a})&&e.onFocusIn(a,b,c,d)})}function u(a,b){var c=b?b[0].nodeName:d;K.forEach(function(e){e.subscribe.find(function(a){return c===d||a===c})&&e.onFocusOut(a,c,b)}),K.forEach(function(d){d.subscribe.find(function(a){return"*"===a})&&d.onFocusOut(a,c,b)})}function v(a){M.hover=a}function w(b){var c,d,e;d=a(b.target),b.preventDefault(),c=parseInt(d.attr("data-extension-binder-id")),e=x(d),K[c]&&(K[c].onClick(parseInt(d.attr("data-button-binder-id")),e,I.lastFocused,b,d),L=y()[3],K[c].show())}function x(a){var b=a.is("[selected]");switch(a.attr("data-button-type")){case"select":return I.menu.find('a[data-group-name="'+a.attr("data-group-name")+'"]').removeAttr("selected"),b?(a.removeAttr("selected"),a.attr("data-button-id")):d;case"radio":return I.menu.find('a[data-group-name="'+a.attr("data-group-name")+'"]').removeAttr("selected"),a.attr("data-button-id");default:return b&&a.removeAttr("selected"),!b}}function y(){var c,d,e,f,g=!1,h=b.getSelection(),i=A(h.focusNode),j=h.isCollapsed===!0&&S===!1;return f=h.focusNode,!1===h.isCollapsed&&!1===R&&a.contains(I.editor[0],h.focusNode)&&(g=!0,e=h.getRangeAt(0),d=e.getBoundingClientRect(),c={top:b.pageYOffset+d.top,left:d.left,right:d.right,bottom:b.pageYOffset+d.bottom,width:d.width,height:d.height}),[j,g,c,i,h]}function z(a){K.forEach(function(b){b.visible&&b.onDraw(a)})}function A(a){var b={};if(a)for(;a.parentNode&&(b[a.nodeName.toLowerCase()]=!0,a!==I.editor[0]);)a=a.parentNode;return b}function B(b,c){var d,e,f=[],g=[],h=[];return c=c||!0,d={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"caps",27:"esc",32:"space",33:"pgup",34:"pgdn",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",91:"cmd",93:"cmd",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",186:";",187:"=",188:",",189:"-",191:"\\/",192:"`",219:"\\[",220:"\\\\",221:"\\]",222:"'"},e=[16,17,18,91,93],b.forEach(function(b){d.hasOwnProperty(b)&&(-1!=a.inArray(b,e)?f.push(d[b]):g.push(d[b]))}),f.sort(),g.sort(),f.length&&h.push(f.join("+")),g.length&&h.push(g.join("+")),"@"+h.join("+")}function C(a){this.id=G+=1,this.init(a)}function D(b,c){var d;c.view=b instanceof a?b:a(b),d=c.view.attr("data-sereno-subscribe"),c.subscribe=d?d.split(" ").filter(function(a){return!!a}):[]}function E(b,c){var d,e=function(b,c,d){var e=b.split(","),f=a("<a>").attr("href","#");e[0]&&f.attr("data-button-id",e[0]),e[1]&&f.html('<i class="fa fa-'+e[1]+'"></i>'),e[2]&&f.html(f.html()+e[2]),f.attr(c),d.append(a("<li>").append(f))};return!b||!b instanceof Array?(console.log("Failed to load extension `"+c.name+"`."),!1):(d=a("<ul>"),b.forEach(function(a){var b,c;if(a instanceof Object){switch(b=!0===a.sep,c=a.name,a.type){case"select":a.buttons.forEach(function(a){e(a,{"data-button-type":"select","data-group-name":c},d)});break;case"radio":a.buttons.forEach(function(a){e(a,{"data-button-type":"radio","data-group-name":c},d)});break;default:a.buttons.forEach(function(a){e(a,{"data-button-type":"checkbox"},d)})}b&&d.find("li:last-child").addClass("group")}}),void(c.view=a("<div>").addClass("menu").attr("data-sereno-ext-id",c.id).append(d)))}var F,G=0,H=0,I={},J={},K=[],L={},M={},N={},O=!1,P={},Q=0,R=!1,S=!1,T=!1,U=100;e.prototype={init:function(){var e;f(),g(),h(),j(),e=c.createRange(),F=b.getSelection(),e.setStart(c.querySelector("[data-serene-edit]"),1),F.removeAllRanges(),F.addRange(e),J.localStorage&&k(),this.extend(new C({name:"options",loadFromSource:I.options,subscribe:[],onDraw:function(c){var e,f=M.hover;if(this.isOpen())return void(M.hover=d);if(f){if(!a.contains(I.editor[0],f.target))return void(M.hover=d);e=editor.topNode(f.target),c={top:e.position().top+e.outerHeight(!0)-this.view.height()/2,left:e.position().left}}else e=b.getSelection().getRangeAt(0).getBoundingClientRect(),console.log([e.top,b.pageYOffset].join(" ")),c={top:b.pageYOffset+e.top+(e.height-this.view.height())/2,left:editor.topNode(F.focusNode).position().left};this.view.css({top:c.top,left:c.left-66}),M.hover=d},onClick:function(a){switch(a){case this.R.toggle:this.isOpen()?this.close():this.open()}},open:function(){this.view.find(".toggle > a").css("transform","rotate(0deg)"),this.view.find(".options-menu").show("fold")},close:function(){this.view.find(".toggle > a").css("transform","rotate(45deg)"),this.view.find(".options-menu").hide("fold")},isOpen:function(){return this.view.is(":visible")||this.view.show(),this.view.find(".options-menu").is(":visible")}}))},extend:function(a){for(var b=T;T;);return O||b?i(a,-1):(K.push(a),K.length-1)},state:function(){return M},nodes:function(){return L},selection:function(){return F},options:function(){return I.options},menu:function(){return I.menu},editor:function(){return I.editor},extensions:function(){return K},topNode:function(b){for(b instanceof a&&(b=b[0]);b&&b.parentNode!=I.editor[0];)b=b.parentNode;return a(b)}},C.prototype={init:function(a){var b,c;if(this.name=a.name,a.loadFromSource){if(!1===D(a.loadFromSource,this))return}else{if(!1===E(a.structure,this))return;this.subscribe=[]}this.subscribe=this.subscribe.concat(a.subscribe),this.status="active",this.view.css({position:"absolute",top:0,left:0}).hide(),this.visible=!1,b=function(a){return a==c};for(c in a)["show","hide","findViewById","init"].find(b)||(this[c]=a[c]);this.menu=a.init?a.init():[]},onClick:function(){},onDraw:function(a){a=a?a:{top:0,left:0},this.view.css({top:a.top,left:a.left})},onFocusIn:function(){this.show()},onFocusOut:function(){this.hide()},onLoad:function(){},onHide:function(){},onShow:function(){},onEvent:function(){},show:function(){this.onDraw(M.where),this.view.find("[selected]").removeAttr("selected"),this.onLoad(M.view,L),this.onShow(),this.view.is(":visible")||this.view.show()},hide:function(){this.onHide(),this.view.is(":visible")&&this.view.hide()},findViewById:function(a){return I.menu.find("[data-button-binder-id="+a+"]")}},b.Editor=e,b.Editor.Extension=C,b.editor=new e}(window.jQuery,window,window.document),window.editor.init(),function(a,b,c,d,e){a.extend(new b({name:"text",loadFromSource:"#serene-editor-text-menu",subscribe:["@cmd+b","@cmd+i","@enter","#text","a","code","p","b","i","strong","em","h1","h2","h3","h4","h5","h6"],onClick:function(a,b){switch(a){case this.R.h1:e.execCommand("formatBlock",!1,b?"p":"h1");break;case this.R.h2:e.execCommand("formatBlock",!1,b?"p":"h2");break;case this.R.h3:e.execCommand("formatBlock",!1,b?"p":"h3");break;case this.R.bold:e.execCommand("bold",!1,null)||e.execCommand("formatBlock",!1,"b");break;case this.R.italic:e.execCommand("italic",!1,null)||e.execCommand("formatBlock",!1,"i")}},onFocusIn:function(){return editor.state().view&&editor.state().view.text().length>0&&this.show(),!0},onLoad:function(a,b){b.h1&&this.findViewById(this.R.h1).attr("selected",""),b.h2&&this.findViewById(this.R.h2).attr("selected",""),b.h3&&this.findViewById(this.R.h3).attr("selected",""),(b.b||b.strong)&&this.findViewById(this.R.bold).attr("selected",""),(b.i||b.em)&&this.findViewById(this.R.italic).attr("selected","")},onEvent:function(a,b,c){switch(a){case"@cmd+b":c.preventDefault(),e.execCommand("bold",!1,null);break;case"@cmd+i":c.preventDefault(),e.execCommand("italic",!1,null)}},onDraw:function(a){a&&this.view.css({top:a.top+a.marginTop-this.view.outerHeight(!0)-5,left:(a.left+a.right-this.view.width())/2})}}))}(window.editor,window.Editor.Extension,window.jQuery,window,window.document);